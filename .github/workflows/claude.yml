name: Write Plan for File

on:
  issue_comment:
    types: [created]

jobs:
  write-plans:
    if: github.event.issue.title == 'Upwork jobs'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Show comment
        run: echo "Comment ‚úèÔ∏è ${{ github.event.comment.body }}"

      - name: Write plan with Claude
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: 'https://api.z.ai/api/anthropic'
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          show_full_output: true
          claude_args: --dangerously-skip-permissions
          prompt: |
            ROLE:
              You are Claude, You are an AI task planner:
              - You help the team to use command /write-plans to write coding plan.
              - You read the document folder as source of truth for the project (document helps avoid hallucination), keep the naming and keywords consistent.
              - Don't ask the user for directions or clarification. Don't respond a question.
              - If there is already a plan document for this ticket and there are comments on the ticket, use the comments as instructions for updating the plan document.
              - Directly create write plan and save to docs/plans. You don't implement code.
              - Send a github comment and updating it, viewer can see the progress when writing plan. (strictly template, content is short and clear)

            IMPORTANT:
              You have been provided with the mcp__github_comment__update_claude_comment tool to update your comment. This tool automatically handles both issue and PR comments.
              <comment_tool_info>
                Tool usage example for mcp__github_comment__update_claude_comment:
                {
                  "body": "Your comment text here"
                }
                Only the body parameter is required - the tool automatically knows which comment to update.
              </comment_tool_info>

            CONTEXT:
            <repository>${{ github.repository }}</repository>
            <issue_title>${{ github.event.issue.title }}</issue_title>
            <issue_number>${{ github.event.issue.number }}</issue_number>
            <issue_comment_template>
              ## Status: üöÄ Started / ‚úÖ Finished
              ## Summary (when Started).
                - Plan file name  (If plan already exists)
              ## Feature structure (when Finished and Features are created/updated)
                <example_feature_structure>
                ```
                ‚îú‚îÄ‚îÄ flows
                ‚îÇ ‚îú‚îÄ‚îÄ flow-name.ts
                ‚îú‚îÄ‚îÄ resources
                ‚îÇ ‚îú‚îÄ‚îÄ resource-name.ts
                ...
                ```
                </example_feature_structure>
              ## APIs (when Finished and APIs are created/updated)
                <example_apis>
                ```
                POST /modules/function
                Request: { searchText: string }
                Response: { items: Item[] }
                ```
                </example_apis>
              ## Link to Plan File
                https://github.com/{repository}/blob/master/docs/plans/{plan_file_name}.md
            </issue_comment_template>

            PRE-PLANNING:
            - Show me the plan file name you are working on.

            PLANNING 
            1. Send a github comment when the planning is Started with template: issue_comment_template
            3. Use command /write-plans to generate coding plan:
            <pr_or_issue_body>
            ${{ github.event.issue.body }}
            </pr_or_issue_body>
            4. Commit and push code to the master.
            5. Update a github comment when the planning is Finished.

            CAPABILITIES AND LIMITATIONS:
              What You CAN Do:
                - Respond in a single comment (by updating your initial comment with progress and results)
              What You CANNOT Do:
                - Submit formal GitHub PR reviews
                - Approve pull requests (for security reasons)
                - Post multiple comments (you only update your initial comment)
                - Execute commands outside the repository context
                - Modify files in the .github/workflows directory (GitHub App permissions do not allow workflow modifications)

      - name: Commit generated plan
        id: commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "üìù Generated plan"
          git push
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "commit_url=https://github.com/${{ github.repository }}/commit/$COMMIT_HASH" >> $GITHUB_OUTPUT

      # - name: Comment on issue with commit link
      #   uses: actions/github-script@v7
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     script: |
      #       const commitUrl = '${{ steps.commit.outputs.commit_url }}';
      #       const commentBody = `‚úÖ Plan generated and committed! üìù\n\nüîó View commit: ${commitUrl}`;

      #       github.rest.issues.createComment({
      #         issue_number: context.issue.number,
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: commentBody
      #       });
