title: Expense Finance Approval Event Storming
description: Event storming model for Purchase Order approval workflow

# Domain Events
domain_events:
  - name: PurchaseOrderCreated
    description: User submits order details creating a draft PO
    properties:
      - po_id: string
      - requester_id: string
      - client_company_id: string
      - vendor_company_id: string
      - total_amount: decimal
      - vat_amount: decimal
      - status: "Draft"
      - created_at: datetime

  - name: PurchaseOrderSubmittedForApproval
    description: User sends PO for approval, changing status to pending
    properties:
      - po_id: string
      - approver_id: string
      - status: "Pending Approval"
      - submitted_at: datetime

  - name: ApprovalGranted
    description: Approver approves the PO
    properties:
      - po_id: string
      - approver_id: string
      - approved_at: datetime
      - status: "Approved"

  - name: ApprovalRejected
    description: Approver rejects the PO with reason
    properties:
      - po_id: string
      - approver_id: string
      - rejection_reason: string
      - rejected_at: datetime
      - status: "Rejected"

  - name: PurchaseOrderCancelled
    description: PO is cancelled by requester or approver
    properties:
      - po_id: string
      - cancelled_by: string
      - cancellation_reason: string
      - cancelled_at: datetime
      - status: "Cancelled"

  - name: PaymentRecorded
    description: Finance records payment for approved PO
    properties:
      - po_id: string
      - payment_amount: decimal
      - payment_date: datetime
      - funding_source: string
      - status: "Paid"

  - name: AuditLogCreated
    description: System creates audit entry for any state change
    properties:
      - po_id: string
      - previous_status: string
      - new_status: string
      - changed_by: string
      - timestamp: datetime
      - action: string

# External Systems
external_systems:
  - name: EmailNotificationService
    description: Sends notifications to approvers and requesters
    events_received:
      - PurchaseOrderSubmittedForApproval
      - ApprovalRejected
      - ApprovalGranted

  - name: FinanceSystem
    description: Manages budget allocation and payment processing
    events_received:
      - ApprovalGranted
      - PaymentRecorded

# Views/Read Models
read_models:
  - name: PurchaseOrderView
    description: Complete PO information with current status
    queries:
      - getPurchaseOrderById(po_id)
      - getPurchaseOrdersByStatus(status)
      - getPurchaseOrdersByRequester(requester_id)
    events_populated:
      - PurchaseOrderCreated
      - PurchaseOrderSubmittedForApproval
      - ApprovalGranted
      - ApprovalRejected
      - PurchaseOrderCancelled
      - PaymentRecorded

  - name: ApprovalHistoryView
    description: Historical approval decisions
    queries:
      - getApprovalHistory(po_id)
      - getApproverWorkload(approver_id)
    events_populated:
      - ApprovalGranted
      - ApprovalRejected

  - name: AuditTrailView
    description: Complete audit log for compliance
    queries:
      - getAuditTrail(po_id)
      - getAuditTrailByDateRange(start_date, end_date)
    events_populated:
      - AuditLogCreated

# Commands
commands:
  - name: CreatePurchaseOrder
    description: Creates a new purchase order
    triggers_event: PurchaseOrderCreated
    data:
      - client_company_id: string
      - vendor_company_id: string
      - service_items: array
      - requester_id: string

  - name: SubmitForApproval
    description: Submits PO for approval
    triggers_event: PurchaseOrderSubmittedForApproval
    data:
      - po_id: string
      - approver_id: string

  - name: ApprovePurchaseOrder
    description: Approves the PO
    triggers_event: ApprovalGranted
    data:
      - po_id: string
      - approver_id: string

  - name: RejectPurchaseOrder
    description: Rejects the PO with reason
    triggers_event: ApprovalRejected
    data:
      - po_id: string
      - approver_id: string
      - rejection_reason: string

  - name: CancelPurchaseOrder
    description: Cancels the PO
    triggers_event: PurchaseOrderCancelled
    data:
      - po_id: string
      - cancelled_by: string
      - cancellation_reason: string

  - name: RecordPayment
    description: Records payment for approved PO
    triggers_event: PaymentRecorded
    data:
      - po_id: string
      - payment_amount: decimal
      - funding_source: string

# Users/Actors
actors:
  - name: Requester
    description: Person who creates and submits POs (Trần Văn Mạnh)
    commands_can_execute:
      - CreatePurchaseOrder
      - SubmitForApproval
      - CancelPurchaseOrder

  - name: Approver
    description: Person who approves/rejects POs (Nguyễn Văn An)
    commands_can_execute:
      - ApprovePurchaseOrder
      - RejectPurchaseOrder
      - CancelPurchaseOrder

  - name: Finance
    description: Finance team that processes payments
    commands_can_execute:
      - RecordPayment

# Aggregates
aggregates:
  - name: PurchaseOrder
    description: Manages PO lifecycle
    commands_handled:
      - CreatePurchaseOrder
      - SubmitForApproval
      - ApprovePurchaseOrder
      - RejectPurchaseOrder
      - CancelPurchaseOrder
    events_published:
      - PurchaseOrderCreated
      - PurchaseOrderSubmittedForApproval
      - ApprovalGranted
      - ApprovalRejected
      - PurchaseOrderCancelled

  - name: PaymentProcessor
    description: Handles payment processing
    commands_handled:
      - RecordPayment
    events_published:
      - PaymentRecorded

  - name: ClientCompany
    description: Client company information
    attributes:
      - name: string
      - address: string
      - tax_id: string
      - contact_info: object

  - name: VendorCompany
    description: Vendor company information
    attributes:
      - name: string
      - address: string
      - contact_info: object
      - responsible_person: object

  - name: ServiceItem
    description: Service line item in PO
    attributes:
      - service_code: string
      - name: string
      - unit: string
      - quantity: number
      - rate: decimal
      - line_total: decimal

  - name: ApprovalRecord
    description: Approval decision record
    attributes:
      - po_id: string
      - approver_id: string
      - action: string
      - timestamp: datetime
      - comments: string

  - name: Finance
    description: Financial information
    attributes:
      - budget: decimal
      - expense_type: string
      - funding_source: string

# Policies
policies:
  - name: NotificationPolicy
    description: Send notifications on certain events
    when:
      - PurchaseOrderSubmittedForApproval -> EmailNotificationService.notifyApprover()
      - ApprovalRejected -> EmailNotificationService.notifyRequester()
      - ApprovalGranted -> EmailNotificationService.notifyRequester()

  - name: AuditPolicy
    description: Create audit log entries
    when:
      - Any status change -> AuditLogCreated()

  - name: FinancePolicy
    description: Allocate budget on approval
    when:
      - ApprovalGranted -> FinanceSystem.allocateBudget()

# Bounded Context
bounded_context:
  name: ExpenseFinanceApproval
  description: Core domain for PO approval workflow
  contains:
    - domain_events
    - commands
    - aggregates
    - read_models
    - policies